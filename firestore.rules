rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Function: Check if user is the Owner
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'deltaastra24@gmail.com';
    }

    // Pricing Configuration (Public Read, Admin Write)
    match /config/pricing {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // User Profile Rules
    match /users/{userId} {
      // User can read their own profile. Admin can read ANY profile.
      allow read: if (request.auth != null && request.auth.uid == userId) || isAdmin();
      
      // User can create their own profile.
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // User update rules (Restricted). Admin can update ANYTHING.
      allow update: if isAdmin() || (
                    request.auth != null && request.auth.uid == userId
                    && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['acronBalance', 'licenses', 'isPro', 'tier', 'lastPurchase'])
                    );
    }
    
    // License Collection Rules (ACRO Server Only or Admin)
    match /licenses/{licenseKey} {
      allow read: if isAdmin();
      allow write: if false; // Server-side admin SDK only
    }

    // Products Rules (Public Read, Admin Write)
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Rules for 'posts'
    match /posts/{postId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null 
                    && request.resource.data.authorId == request.auth.uid
                    && request.resource.data.content.size() < 1000;
      
      allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
    }
  }
}
